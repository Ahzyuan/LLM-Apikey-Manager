#!/bin/bash

# LAM (LLM API Manager) - Modular Version
# A secure tool to manage LLM API keys and base URLs
# Author: Ahzyuan

set -euo pipefail

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Configuration - use actual user's home directory, not root's when installed system-wide
if [[ $EUID -eq 0 ]] && [[ -n "${SUDO_USER:-}" ]]; then
    # Running as root via sudo - use the original user's home
    USER_HOME=$(eval echo ~$SUDO_USER)
    CONFIG_DIR="$USER_HOME/.config/lam"
elif [[ $EUID -eq 0 ]]; then
    # Running as actual root user
    CONFIG_DIR="/root/.config/lam"
else
    # Running as regular user
    CONFIG_DIR="$HOME/.config/lam"
fi

CONFIG_FILE="$CONFIG_DIR/config.enc"
LOCK_FILE="$CONFIG_DIR/.lock"
SESSION_FILE="$CONFIG_DIR/.session"

# Security constants
readonly MAX_PASSWORD_LENGTH=256
readonly MIN_PASSWORD_LENGTH=8
readonly MAX_INPUT_LENGTH=4096
readonly SESSION_TIMEOUT=${LAM_SESSION_TIMEOUT:-1800}  # 30 minutes default

# Load modules
source "$SCRIPT_DIR/lib/utils.sh"
source "$SCRIPT_DIR/lib/security.sh"
source "$SCRIPT_DIR/lib/config.sh"
source "$SCRIPT_DIR/lib/commands.sh"

# Set trap for cleanup on exit
trap cleanup_temp_resources EXIT

# Main function with enhanced error handling
main() {
    # Set up error handling
    set -eE
    trap 'handle_error $? "Unexpected error occurred" $LINENO' ERR
    
    check_dependencies
    
    local command="${1:-help}"
    
    # Commands that don't require initialization
    case "$command" in
        "init"|"update"|"uninstall"|"help"|"-h"|"version"|"-v")
            # These commands can run without initialization
            ;;
        *)
            # All other commands require initialization
            check_initialization
            ;;
    esac
    
    case "$command" in
        "init")
            cmd_init
            ;;
        "add")
            cmd_add "${2:-}"
            ;;
        "list"|"ls")
            cmd_list
            ;;
        "show")
            cmd_show "${2:-}"
            ;;
        "use")
            cmd_use "${2:-}"
            ;;
        "edit")
            cmd_edit "${2:-}"
            ;;
        "delete"|"del")
            cmd_delete "${2:-}"
            ;;
        "test")
            cmd_test
            ;;
        "backup"|"bak")
            cmd_backup "${2:-}"
            ;;
        "status")
            cmd_stats
            ;;
        "update")
            cmd_update
            ;;
        "uninstall")
            cmd_uninstall
            ;;
        "help"|"-h")
            cmd_help
            ;;
        "version"|"-v")
            cmd_version
            ;;
        *)
            log_error "Unknown command: $command"
            echo
            echo "Use 'lam help' for available commands."
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"